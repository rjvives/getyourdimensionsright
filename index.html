<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Measure Mapper · Flow (CSV + Hero)</title>
  <style>
    :root {
      --bg:#101214;
      --card:#181c20;
      --ink:#e5e7eb;
      --muted:#9ca3af;
      --line:#2a2f35;
      --accent:#60a5fa;
      --overlay:#0f1117c9;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      background:var(--bg);
      color:var(--ink);
      font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:28px 18px 64px;}
    h1{font-size:clamp(24px,4vw,36px);margin:0 0 10px;}
    p.lead{color:var(--muted);margin:0 0 20px;}

    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;}

    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    .row>*{flex:1;min-width:180px;}
    label{font-size:12px;color:var(--muted);margin-bottom:6px;display:block;}

    select{width:100%;padding:10px 12px;border-radius:12px;
           border:1px solid var(--line);background:#0d0f12;color:var(--ink);}
    select:focus{border-color:var(--accent);outline:none;}

    .slider-row{display:flex;align-items:center;gap:14px;}
    input[type="range"]{
      flex:1;appearance:none;height:6px;border-radius:999px;outline:none;
      background:linear-gradient(90deg,#24282d,#1c1f24);
    }
    input[type="range"]::-webkit-slider-thumb{
      -webkit-appearance:none;width:18px;height:18px;border-radius:50%;
      background:var(--accent);border:2px solid #0a0c10;
    }
    input[type="range"]::-moz-range-thumb{
      width:18px;height:18px;border-radius:50%;background:var(--accent);border:2px solid #0a0c10;
    }
    .value-pill{min-width:180px;text-align:right;}
    .value-pill b{font-size:18px;}
    .muted{color:var(--muted);}
    .small{font-size:12px;}
    .hr{height:1px;background:var(--line);margin:14px 0;border:0;}

    /* HERO IMAGE */
    .hero{position:relative;margin-top:20px;border-radius:18px;overflow:hidden;border:1px solid var(--line);}
    .hero img{width:100%;height:500px;object-fit:cover;display:block;}
    .overlay{position:absolute;inset:0;background:linear-gradient(180deg,rgba(0,0,0,0.2) 0%, rgba(0,0,0,.7) 100%);}
    .chip{position:absolute;top:14px;padding:8px 10px;border-radius:10px;
          background:rgba(0,0,0,0.55);color:#fff;font-size:13px;}
    .chip.left{left:14px;}
    .chip.right{right:14px;max-width:40%;}
    .center-text{
      position:absolute;top:10%;left:50%;transform:translate(-50%,-50%);
      text-align:center;color:#fff;text-shadow:0 4px 10px rgba(0,0,0,0.7);
    }
    .center-text h2{
      margin:0;font-size:clamp(28px,6vw,52px);font-weight:800;letter-spacing:0.12em;text-transform:uppercase;
    }
    .center-text .sub{margin-top:6px;font-size:clamp(14px,2vw,20px);color:#d1d5db;}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Flow (m³/s) <span class="small muted">· datos desde CSV</span></h1>
    <p class="lead">Elige una <b>escala</b>, mueve el <b>slider</b> y observa el río representativo.</p>

    <!-- CONTROLES -->
    <section class="card">
      <div class="row" style="margin-bottom:10px;">
        <div>
          <label>Zoom / Escala</label>
          <select id="zoomSelect"></select>
        </div>
      </div>
      <div class="hr"></div>
      <div>
        <label class="muted">Caudal</label>
        <div class="slider-row">
          <input id="valueSlider" type="range" min="0" max="1000" step="1" value="100"/>
          <div class="value-pill"><b id="valueReadout">100</b> <span>m³/s</span></div>
        </div>
        <div class="small muted" id="rangeReadout" style="margin-top:6px;"></div>
      </div>
    </section>

    <!-- HERO -->
    <section class="hero" id="hero">
      <img id="heroImg" alt=""/>
      <div class="overlay"></div>
      <div class="chip left" id="chipRange">Rango: —</div>
      <div class="chip right" id="chipDesc">—</div>
      <div class="center-text">
        <h2 id="heroTitle">—</h2>
        <div class="sub" id="heroSub">—</div>
      </div>
    </section>

    <div class="small muted" style="margin-top:10px;">Fuente: <code>flow_rivers.csv</code></div>
  </div>

  <script>
    const CSV_URL = 'flow_rivers.csv?v=20250826';
    const fmt = (n) => new Intl.NumberFormat().format(n);
    function niceStep(x){if(x<=0)return 1;const k=Math.floor(Math.log10(x));const b=x/10**k;const m=b<=1?1:b<=2?2:b<=5?5:10;return m*10**k;}

    function detectDelimiter(line){const c=[',',';','\t'];let best=',',count=0;for(const d of c){const n=line.split(d).length-1;if(n>count){count=n;best=d;}}return best;}
    function parseCSV(text){
      if(text.charCodeAt(0)===0xFEFF) text=text.slice(1);
      const firstNL=text.indexOf('\n');const firstLine=firstNL>=0?text.slice(0,firstNL):text;
      const DELIM=detectDelimiter(firstLine);
      const rows=[];let cur=[],field='',inQuotes=false;
      for(let i=0;i<text.length;i++){const c=text[i];
        if(c==='"'){if(inQuotes&&text[i+1]==='"'){field+='"';i++;}else inQuotes=!inQuotes;}
        else if(c===DELIM&&!inQuotes){cur.push(field);field='';}
        else if((c==='\n'||c==='\r')&&!inQuotes){if(c==='\r'&&text[i+1]==='\n')i++;cur.push(field);rows.push(cur);cur=[];field='';}
        else{field+=c;}
      }
      if(field!==''||cur.length){cur.push(field);rows.push(cur);}
      if(!rows.length)return[];const headers=rows.shift().map(h=>h.trim());
      return rows.filter(r=>r.length&&r.some(x=>x.trim()!=='')).map(r=>{const obj={};headers.forEach((h,i)=>obj[h]=r[i]?r[i].trim():'');return obj;});
    }

    let DB={byScale:new Map(),scales:[]};
    async function loadCSV(){
      const res=await fetch(CSV_URL);if(!res.ok)throw new Error('No se pudo cargar CSV');
      const txt=await res.text();const rows=parseCSV(txt);
      const byScale=new Map();
      for(const row of rows){
        const scale=row['Scale'],name=row['Name'],value=parseFloat(row['Value'].replace(',','.'));
        const desc=row['Description'],img=row['Image'];const r=row['Value range'];
        if(!scale||!name||!r)continue;const m=r.match(/^(\d+(?:[\.,]\d+)?)\s*-\s*(\d+(?:[\.,]\d+)?)/);
        if(!m)continue;const rmin=parseFloat(m[1].replace(',','.')),rmax=parseFloat(m[2].replace(',','.'));
        const item={scale,name,value,rmin,rmax,desc,image:img};
        if(!byScale.has(scale))byScale.set(scale,[]);byScale.get(scale).push(item);
      }
      for(const [s,arr] of byScale){arr.sort((a,b)=>a.rmin-b.rmin);arr.forEach((it,i)=>it.slot=i+1);}
      DB.byScale=byScale;DB.scales=[...byScale.keys()];
    }

    function populateZooms(){
      const sel=document.getElementById('zoomSelect');sel.innerHTML='';
      for(const z of DB.scales){const o=document.createElement('option');o.value=z;o.textContent=z;sel.appendChild(o);}
    }
    function setSliderToScale(scale){
      const arr=DB.byScale.get(scale)||[];if(!arr.length)return;
      const min=Math.min(...arr.map(x=>x.rmin)),max=Math.max(...arr.map(x=>x.rmax));
      const s=document.getElementById('valueSlider');const step=niceStep((max-min)/200);
      s.min=min;s.max=max;s.step=step;if(s.value<min||s.value>max)s.value=min;
      document.getElementById('rangeReadout').textContent=`Rango → ${fmt(min)} – ${fmt(max)} m³/s (step ${fmt(step)})`;
      document.getElementById('valueReadout').textContent=fmt(s.value);
    }
    function findMatch(scale,val){
      const arr=DB.byScale.get(scale)||[];let m=arr.find(x=>val>=x.rmin&&val<=x.rmax);
      if(m)return m;let best=null,dist=1e9;for(const it of arr){const c=(it.rmin+it.rmax)/2;const d=Math.abs(val-c);if(d<dist){dist=d;best=it;}}return best;
    }

    function render(){
      const scale=document.getElementById('zoomSelect').value;
      const val=parseFloat(document.getElementById('valueSlider').value);
      const m=findMatch(scale,val);
      const heroImg=document.getElementById('heroImg'),chipRange=document.getElementById('chipRange'),
            chipDesc=document.getElementById('chipDesc'),heroTitle=document.getElementById('heroTitle'),
            heroSub=document.getElementById('heroSub');
      if(!m){heroImg.removeAttribute('src');heroTitle.textContent='SIN DATOS';heroSub.textContent=`Zoom: ${scale} · ${fmt(val)} m³/s`;chipRange.textContent='Rango: —';chipDesc.textContent='—';return;}
      if(m.image){heroImg.src=m.image;}else{heroImg.removeAttribute('src');}
      chipRange.textContent=`Rango: ${fmt(m.rmin)}–${fmt(m.rmax)} m³/s`;
      chipDesc.textContent=m.desc||'—';
      heroTitle.textContent=m.name.toUpperCase();
      heroSub.textContent=`Caudal ref: ${fmt(m.value)} m³/s`;
    }

    document.getElementById('zoomSelect').addEventListener('change',()=>{setSliderToScale(zoomSelect.value);render();});
    document.getElementById('valueSlider').addEventListener('input',()=>{document.getElementById('valueReadout').textContent=fmt(valueSlider.value);render();});

    (async function init(){
      await loadCSV();populateZooms();
      if(DB.scales.length){document.getElementById('zoomSelect').value=DB.scales[0];setSliderToScale(DB.scales[0]);}
      render();
    })();
  </script>
</body>
</html>
